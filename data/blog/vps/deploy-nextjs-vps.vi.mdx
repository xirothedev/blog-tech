---
title: "H∆∞·ªõng d·∫´n Deploy Next.js l√™n VPS: Self-hosting v·ªõi Docker v√† Nginx"
date: "2025-11-02"
lastmod: "2025-11-02"
tags: ["nextjs", "deployment", "vps", "docker", "nginx", "self-hosting"]
draft: false
summary: "H∆∞·ªõng d·∫´n chi ti·∫øt c√°ch deploy ·ª©ng d·ª•ng Next.js l√™n VPS s·ª≠ d·ª•ng Docker, PostgreSQL v√† Nginx. Bao g·ªìm c√°c b∆∞·ªõc t·ª´ setup server ƒë·∫øn production deployment."
authors: ["default"]
locale: "vi"
images: ["/static/images/vps/deploy-nextjs-vps/thumbnail.png"]
---

Deploy Next.js l√™n VPS l√† m·ªôt k·ªπ nƒÉng quan tr·ªçng cho c√°c developer mu·ªën t·ª± qu·∫£n l√Ω infrastructure c·ªßa m√¨nh. So v·ªõi c√°c platform nh∆∞ Vercel, vi·ªác self-host tr√™n VPS cho b·∫°n ki·ªÉm so√°t ho√†n to√†n, t√πy ch·ªânh cao v√† chi ph√≠ c√≥ th·ªÉ th·∫•p h∆°n. B√†i vi·∫øt n√†y s·∫Ω h∆∞·ªõng d·∫´n b·∫°n deploy Next.js app l√™n [VPS](/blog/vps) s·ª≠ d·ª•ng Docker, PostgreSQL v√† Nginx.

<TOCInline
	toc={[
		{ value: "T·ªïng quan", url: "#t·ªïng-quan", depth: 2 },
		{ value: "Prerequisites", url: "#prerequisites", depth: 2 },
		{ value: "Ki·∫øn tr√∫c Deployment", url: "#ki·∫øn-tr√∫c-deployment", depth: 2 },
		{ value: "Setup Server", url: "#setup-server", depth: 2 },
		{ value: "C√†i ƒë·∫∑t Docker v√† Docker Compose", url: "#c√†i-ƒë·∫∑t-docker-v√†-docker-compose", depth: 2 },
		{ value: "Setup Nginx", url: "#setup-nginx", depth: 2 },
		{ value: "C·∫•u h√¨nh Next.js Application", url: "#c·∫•u-h√¨nh-nextjs-application", depth: 2 },
		{ value: "C·∫•u h√¨nh PostgreSQL", url: "#c·∫•u-h√¨nh-postgresql", depth: 2 },
		{ value: "Deploy Script", url: "#deploy-script", depth: 2 },
		{ value: "SSL Certificate v·ªõi Let's Encrypt", url: "#ssl-certificate-v·ªõi-lets-encrypt", depth: 2 },
		{ value: "Rate Limiting v√† Security", url: "#rate-limiting-v√†-security", depth: 2 },
		{ value: "Update v√† Maintenance", url: "#update-v√†-maintenance", depth: 2 },
		{ value: "Troubleshooting", url: "#troubleshooting", depth: 2 },
		{ value: "Best Practices", url: "#best-practices", depth: 2 },
		{ value: "K·∫øt lu·∫≠n", url: "#k·∫øt-lu·∫≠n", depth: 2 },
	]}
	asDisclosure={true}
	collapse={false}
/>

## T·ªïng quan

H∆∞·ªõng d·∫´n n√†y d·ª±a tr√™n [next-self-host repository](https://github.com/leerob/next-self-host) c·ªßa Lee Robinson, m·ªôt v√≠ d·ª• v·ªÅ c√°ch deploy Next.js app v·ªõi PostgreSQL database tr√™n Ubuntu server s·ª≠ d·ª•ng Docker v√† Nginx.

### Stack c√¥ng ngh·ªá:

| Component            | Technology              | M·ª•c ƒë√≠ch                                     |
| -------------------- | ----------------------- | -------------------------------------------- |
| **Application**      | Next.js                 | React framework v·ªõi SSR/SSG                  |
| **Database**         | PostgreSQL              | Relational database                          |
| **Containerization** | Docker & Docker Compose | Isolate v√† qu·∫£n l√Ω containers                |
| **Web Server**       | Nginx                   | Reverse proxy, SSL termination, static files |
| **SSL**              | Let's Encrypt           | HTTPS encryption                             |
| **OS**               | Ubuntu Linux            | Server operating system                      |

### T·∫°i sao Self-hosting?

**∆Øu ƒëi·ªÉm:**

- ‚úÖ Ki·ªÉm so√°t ho√†n to√†n infrastructure
- ‚úÖ Chi ph√≠ c√≥ th·ªÉ th·∫•p h∆°n (kh√¥ng ph·ª• thu·ªôc v√†o usage-based pricing)
- ‚úÖ T√πy ch·ªânh cao (c√†i ƒë·∫∑t b·∫•t k·ª≥ ph·∫ßn m·ªÅm n√†o)
- ‚úÖ Hi·ªÉu r√µ c√°ch h·ªá th·ªëng ho·∫°t ƒë·ªông
- ‚úÖ Kh√¥ng b·ªã gi·ªõi h·∫°n b·ªüi platform rules

**Nh∆∞·ª£c ƒëi·ªÉm:**

- ‚ùå C·∫ßn qu·∫£n l√Ω v√† maintain server
- ‚ùå Tr√°ch nhi·ªám v·ªÅ security v√† updates
- ‚ùå C·∫ßn ki·∫øn th·ª©c v·ªÅ DevOps
- ‚ùå Kh√¥ng c√≥ managed scaling t·ª± ƒë·ªông

## Prerequisites

Tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu, b·∫°n c·∫ßn chu·∫©n b·ªã:

### 1. **Domain Name**

Mua m·ªôt domain name v√† chu·∫©n b·ªã c·∫•u h√¨nh DNS:

- T·∫°o A record tr·ªè ƒë·∫øn IP c·ªßa VPS
- Th·ªùi gian propagate: th∆∞·ªùng 5-30 ph√∫t, c√≥ th·ªÉ ƒë·∫øn 48 gi·ªù

### 2. **VPS Server**

Y√™u c·∫ßu t·ªëi thi·ªÉu cho Next.js app:

- **RAM**: 2GB+ (khuy·∫øn ngh·ªã 4GB+)
- **CPU**: 2 cores+ (khuy·∫øn ngh·ªã 4 cores)
- **Storage**: 20GB+ (khuy·∫øn ngh·ªã 40GB+)
- **OS**: Ubuntu 20.04 LTS ho·∫∑c m·ªõi h∆°n

**N∆°i mua VPS:**

- DigitalOcean (Droplets)
- AWS EC2
- Azure VMs
- Linode
- Vultr

### 3. **Ki·∫øn th·ª©c c∆° b·∫£n**

- SSH v√† command line
- Git basics
- Hi·ªÉu c∆° b·∫£n v·ªÅ Docker
- Quen thu·ªôc v·ªõi Next.js

## Ki·∫øn tr√∫c Deployment

<Image
	width={1000}
	height={600}
	src="/static/images/vps/deploy-nextjs-vps/architecture.svg"
	alt="Ki·∫øn tr√∫c Deployment"
/>

### Lu·ªìng request:

```
User ‚Üí Domain ‚Üí DNS ‚Üí Nginx (Port 80/443)
                        ‚Üì
                   Docker Network
                        ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚Üì                   ‚Üì
         Next.js App         PostgreSQL DB
        (Port 3000)         (Port 5432)
```

### C√°c th√†nh ph·∫ßn:

1. **Nginx**: Reverse proxy, x·ª≠ l√Ω SSL, serve static files
2. **Next.js Container**: Ch·∫°y Next.js application
3. **PostgreSQL Container**: Database server
4. **Docker Network**: K·∫øt n·ªëi c√°c containers

## Setup Server

### 1. **SSH v√†o Server**

```bash
ssh root@your_server_ip
# ho·∫∑c n·∫øu d√πng non-root user
ssh user@your_server_ip
```

### 2. **Update h·ªá th·ªëng**

```bash
sudo apt update && sudo apt upgrade -y
```

### 3. **C√†i ƒë·∫∑t c√°c packages c∆° b·∫£n**

```bash
sudo apt install -y curl wget git build-essential
```

## C√†i ƒë·∫∑t Docker v√† Docker Compose

### C√†i ƒë·∫∑t Docker

```bash
# Remove old versions
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done

# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# Install latest version
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Start Docker service
sudo systemctl status docker
sudo systemctl start docker

# Verify installation
docker --version
```

### Th√™m user v√†o docker group (optional)

```bash
sudo usermod -aG docker $USER
newgrp docker
```

## Setup Nginx

Ph·∫ßn n√†y h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t v√† c·∫•u h√¨nh Nginx tr√™n Ubuntu 20.04, d·ª±a tr√™n [h∆∞·ªõng d·∫´n ch√≠nh th·ª©c c·ªßa DigitalOcean](https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04).

### C√†i ƒë·∫∑t Nginx

```bash
# Update package index
sudo apt update

# Install Nginx
sudo apt install nginx

# Verify installation
nginx -v
```

### ƒêi·ªÅu ch·ªânh Firewall

Tr∆∞·ªõc khi ki·ªÉm tra Nginx, b·∫°n c·∫ßn ƒëi·ªÅu ch·ªânh firewall ƒë·ªÉ cho ph√©p traffic:

```bash
# Check firewall status
sudo ufw status

# N·∫øu firewall ch∆∞a active, enable n√≥
sudo ufw enable

# Allow OpenSSH (quan tr·ªçng - n·∫øu kh√¥ng b·∫°n c√≥ th·ªÉ b·ªã lock out)
sudo ufw allow 'OpenSSH'

# Allow Nginx traffic
sudo ufw allow 'Nginx Full'
# Ho·∫∑c ch·ªâ cho ph√©p HTTP/HTTPS ri√™ng:
# sudo ufw allow 'Nginx HTTP'
# sudo ufw allow 'Nginx HTTPS'

# Ho·∫∑c cho ph√©p theo port:
# sudo ufw allow 80/tcp
# sudo ufw allow 443/tcp

# Verify firewall rules
sudo ufw status
```

> [!WARNING]
> **Quan tr·ªçng**: Lu√¥n cho ph√©p OpenSSH tr∆∞·ªõc khi enable firewall, n·∫øu kh√¥ng b·∫°n c√≥ th·ªÉ b·ªã lock out kh·ªèi server!

### Ki·ªÉm tra Web Server

Sau khi c√†i ƒë·∫∑t v√† c·∫•u h√¨nh firewall:

```bash
# Check Nginx status
sudo systemctl status nginx

# N·∫øu ch∆∞a ch·∫°y, start Nginx
sudo systemctl start nginx

# Enable Nginx ƒë·ªÉ t·ª± ƒë·ªông start khi reboot
sudo systemctl enable nginx
```

Ki·ªÉm tra Nginx ho·∫°t ƒë·ªông:

- Truy c·∫≠p `http://your_server_ip` trong browser
- Ho·∫∑c d√πng curl: `curl http://localhost`

B·∫°n s·∫Ω th·∫•y Nginx welcome page n·∫øu c√†i ƒë·∫∑t th√†nh c√¥ng.

### Qu·∫£n l√Ω Nginx Process

C√°c l·ªánh qu·∫£n l√Ω Nginx th∆∞·ªùng d√πng:

| L·ªánh                           | M√¥ t·∫£                            |
| ------------------------------ | -------------------------------- |
| `sudo systemctl stop nginx`    | D·ª´ng Nginx                       |
| `sudo systemctl start nginx`   | Kh·ªüi ƒë·ªông Nginx                  |
| `sudo systemctl restart nginx` | Kh·ªüi ƒë·ªông l·∫°i Nginx              |
| `sudo systemctl reload nginx`  | Reload config kh√¥ng d·ª´ng service |
| `sudo systemctl status nginx`  | Ki·ªÉm tra tr·∫°ng th√°i              |
| `sudo systemctl disable nginx` | T·∫Øt auto-start                   |
| `sudo systemctl enable nginx`  | B·∫≠t auto-start                   |

**Reload vs Restart:**

- `reload`: Load config m·ªõi m√† kh√¥ng drop connections (khuy√™n d√πng cho production)
- `restart`: D·ª´ng v√† start l·∫°i service (c√≥ th·ªÉ drop connections)

### C·∫•u h√¨nh Server Blocks

Server blocks cho ph√©p host nhi·ªÅu domain tr√™n m·ªôt server. T·∫°o server block cho Next.js app:

```bash
# T·∫°o file config cho domain c·ªßa b·∫°n
sudo nano /etc/nginx/sites-available/your-domain.com
```

N·ªôi dung file config c∆° b·∫£n cho Next.js:

```nginx
server {
    listen 80;
    listen [::]:80;

    server_name your-domain.com www.your-domain.com;

    # Logging
    access_log /var/log/nginx/your-domain.access.log;
    error_log /var/log/nginx/your-domain.error.log;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### K√≠ch ho·∫°t Server Block

Sau khi t·∫°o file config:

```bash
# T·∫°o symbolic link ƒë·ªÉ enable site
sudo ln -s /etc/nginx/sites-available/your-domain.com /etc/nginx/sites-enabled/

# Test Nginx config (quan tr·ªçng - ki·ªÉm tra syntax)
sudo nginx -t

# N·∫øu test th√†nh c√¥ng, reload Nginx
sudo systemctl reload nginx

# Remove default site (optional)
sudo rm /etc/nginx/sites-enabled/default
```

### C·∫•u tr√∫c file v√† th∆∞ m·ª•c Nginx quan tr·ªçng

| File/Directory                | M√¥ t·∫£                                   |
| ----------------------------- | --------------------------------------- |
| `/etc/nginx/nginx.conf`       | File config ch√≠nh c·ªßa Nginx             |
| `/etc/nginx/sites-available/` | Ch·ª©a server block configs (ch∆∞a active) |
| `/etc/nginx/sites-enabled/`   | Symbolic links ƒë·∫øn active server blocks |
| `/var/www/html/`              | Default web root directory              |
| `/var/log/nginx/access.log`   | Access logs                             |
| `/var/log/nginx/error.log`    | Error logs                              |
| `/etc/nginx/snippets/`        | Reusable config snippets                |

### Ki·ªÉm tra c·∫•u h√¨nh

```bash
# Test c·∫•u h√¨nh (quan tr·ªçng - lu√¥n ch·∫°y tr∆∞·ªõc khi reload)
sudo nginx -t

# N·∫øu c√≥ l·ªói, xem error log
sudo tail -f /var/log/nginx/error.log

# Xem access log
sudo tail -f /var/log/nginx/access.log
```

> [!TIP]
> Lu√¥n ch·∫°y `sudo nginx -t` tr∆∞·ªõc khi reload/restart Nginx ƒë·ªÉ tr√°nh l√†m down server do config sai!

## C·∫•u h√¨nh Next.js Application

### 1. **Clone Repository**

```bash
git clone https://github.com/leerob/next-self-host.git
cd next-self-host
```

### 2. **C·∫•u tr√∫c Project**

D·ª±a tr√™n [next-self-host repo](https://github.com/leerob/next-self-host), project c√≥ c·∫•u tr√∫c:

```
next-self-host/
‚îú‚îÄ‚îÄ app/                   # Next.js app directory
‚îú‚îÄ‚îÄ public/                # Static files
‚îú‚îÄ‚îÄ Dockerfile             # Container definition
‚îú‚îÄ‚îÄ docker-compose.yml     # Multi-container setup
‚îú‚îÄ‚îÄ deploy.sh              # Deployment script
‚îú‚îÄ‚îÄ update.sh              # Update script
‚îú‚îÄ‚îÄ next.config.ts         # Next.js configuration
‚îú‚îÄ‚îÄ package.json           # Dependencies
‚îî‚îÄ‚îÄ .env                   # Environment variables
```

### 3. **Dockerfile**

Dockerfile m·∫´u cho Next.js:

```dockerfile
FROM oven/bun:alpine AS base

# Stage 1: Install dependencies
FROM base AS deps
WORKDIR /app
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile

# Stage 2: Build the application
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN bun run build

# Stage 3: Production server
FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
CMD ["bun", "run", "server.js"]
```

### 4. **docker-compose.yml**

```yaml
services:
    web:
        build: .
        ports:
            - "3000:3000"
        environment:
            - NODE_ENV=production
        depends_on:
            - db
        networks:
            - my_network

    db:
        image: postgres:latest
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - my_network

    cron:
        image: alpine/curl
        command: >
            sh -c "
              echo '*/10 * * * * curl -X POST http://web:3000/db/clear' > /etc/crontabs/root && \
              crond -f -l 2
            "
        depends_on:
            - web
        networks:
            - my_network

volumes:
    postgres_data:

networks:
    my_network:
        name: my_network
        driver: bridge
```

## C·∫•u h√¨nh PostgreSQL

### Database Setup

Sau khi containers ch·∫°y, setup database schema:

```bash
# V√†o PostgreSQL container
docker exec -it myapp-db-1 sh

# Install PostgreSQL client
apk add --no-cache postgresql-client

# Connect to database
psql -U myuser -d mydatabase

# T·∫°o table (v√≠ d·ª•)
CREATE TABLE IF NOT EXISTS "todos" (
  "id" serial PRIMARY KEY NOT NULL,
  "content" varchar(255) NOT NULL,
  "completed" boolean DEFAULT false,
  "created_at" timestamp DEFAULT now()
);
```

### S·ª≠ d·ª•ng Drizzle ORM

N·∫øu project s·ª≠ d·ª•ng Drizzle (nh∆∞ trong repo):

```bash
# Install dependencies
npm install

# Run migrations
npm run db:migrate

# Ho·∫∑c s·ª≠ d·ª•ng Drizzle Studio
npm run db:studio
```

## Deploy Script

Deploy script t·ª± ƒë·ªông h√≥a to√†n b·ªô qu√° tr√¨nh deployment. D·ª±a tr√™n [deploy.sh t·ª´ repo](https://github.com/leerob/next-self-host/blob/main/deploy.sh):

### C√°c b∆∞·ªõc script th·ª±c hi·ªán:

| B∆∞·ªõc                     | C√¥ng vi·ªác             | Chi ti·∫øt                                 |
| ------------------------ | --------------------- | ---------------------------------------- |
| **1. Setup Packages**    | C√†i ƒë·∫∑t dependencies  | curl, git, Docker, Docker Compose, Nginx |
| **2. Clone Repository**  | Download source code  | Clone t·ª´ GitHub ho·∫∑c t·ª´ local            |
| **3. Generate SSL**      | T·∫°o SSL certificate   | S·ª≠ d·ª•ng Certbot (Let's Encrypt)          |
| **4. Build Application** | Build Next.js app     | Docker build v·ªõi Dockerfile              |
| **5. Configure Nginx**   | Setup reverse proxy   | C·∫•u h√¨nh HTTPS, rate limiting            |
| **6. Setup Database**    | Initialize PostgreSQL | T·∫°o database v√† tables                   |
| **7. Start Services**    | Kh·ªüi ƒë·ªông containers  | docker-compose up -d                     |
| **8. Setup Cron**        | Automated tasks       | C√°c job ƒë·ªãnh k·ª≥ (optional)               |

### S·ª≠ d·ª•ng Deploy Script

```bash
# Download script
curl -o ~/deploy.sh https://raw.githubusercontent.com/leerob/next-self-host/main/deploy.sh

# Ch·ªânh s·ª≠a c√°c bi·∫øn
nano ~/deploy.sh
# Thay ƒë·ªïi: EMAIL, DOMAIN_NAME

# Ch·∫°y script
chmod +x ~/deploy.sh
./deploy.sh
```

### V√≠ d·ª• deploy.sh (t·ª± t·∫°o)

```bash
#!/bin/bash

set -e

# Configuration
EMAIL="your-email@example.com"
DOMAIN="your-domain.com"
PROJECT_DIR="/opt/nextjs-app"

echo "Starting deployment..."

# Update system
apt update && apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# Install Nginx
apt install -y nginx

# Clone repository
git clone https://github.com/leerob/next-self-host.git $PROJECT_DIR
cd $PROJECT_DIR

# Generate SSL certificate
apt install -y certbot python3-certbot-nginx
certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m $EMAIL

# Build and start containers
docker-compose build
docker-compose up -d

echo "Deployment completed!"
```

## SSL Certificate v·ªõi Let's Encrypt

### C√†i ƒë·∫∑t Certbot

```bash
sudo apt install -y certbot python3-certbot-nginx
```

### Generate SSL Certificate

```bash
# Automatic configuration v·ªõi Nginx
sudo certbot --nginx -d your-domain.com

# Ho·∫∑c ch·ªâ generate certificate
sudo certbot certonly --nginx -d your-domain.com
```

### Auto-renewal

Certbot t·ª± ƒë·ªông setup cron job ƒë·ªÉ renew certificate:

```bash
# Test renewal
sudo certbot renew --dry-run

# Check renewal status
sudo systemctl status certbot.timer
```

## Rate Limiting v√† Security

### Nginx Rate Limiting

C·∫•u h√¨nh rate limiting trong Nginx ƒë·ªÉ b·∫£o v·ªá server:

```nginx
# /etc/nginx/nginx.conf
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        location /api {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://localhost:3000;
        }
    }
}
```

### Security Headers

Th√™m security headers trong Nginx config:

```nginx
server {
    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Proxy settings
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### Firewall Configuration

```bash
# Install UFW (n·∫øu ch∆∞a c√≥)
sudo apt install -y ufw

# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP v√† HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status
```

## Update v√† Maintenance

### Update Script

S·ª≠ d·ª•ng `update.sh` ƒë·ªÉ update application:

```bash
#!/bin/bash

set -e

cd /opt/nextjs-app

# Pull latest code
git pull origin main

# Rebuild containers
docker-compose build

# Restart services
docker-compose up -d

# Clean up old images
docker image prune -f

echo "Update completed!"
```

### Maintenance Commands

| M·ª•c ƒë√≠ch                    | Command                                         | M√¥ t·∫£                                 |
| --------------------------- | ----------------------------------------------- | ------------------------------------- |
| **Check containers**        | `docker-compose ps`                             | Xem tr·∫°ng th√°i containers             |
| **View logs**               | `docker-compose logs web`                       | Xem logs c·ªßa Next.js app              |
| **View DB logs**            | `docker-compose logs db`                        | Xem logs c·ªßa PostgreSQL               |
| **Restart services**        | `docker-compose restart`                        | Kh·ªüi ƒë·ªông l·∫°i t·∫•t c·∫£ services         |
| **Stop services**           | `docker-compose down`                           | D·ª´ng v√† x√≥a containers                |
| **Start services**          | `docker-compose up -d`                          | Kh·ªüi ƒë·ªông containers trong background |
| **Restart Nginx**           | `sudo systemctl restart nginx`                  | Kh·ªüi ƒë·ªông l·∫°i Nginx                   |
| **Enter Next.js container** | `docker exec -it myapp-web-1 sh`                | V√†o trong container                   |
| **Enter DB container**      | `docker exec -it myapp-db-1 psql -U user -d db` | V√†o PostgreSQL CLI                    |

### Backup Strategy

| Lo·∫°i Backup               | T·∫ßn su·∫•t       | C√°ch th·ª±c hi·ªán                         |
| ------------------------- | -------------- | -------------------------------------- |
| **Database Backup**       | Daily          | `pg_dump` ho·∫∑c Docker volume backup    |
| **Application Code**      | Per deployment | Git repository                         |
| **Environment Variables** | On changes     | Secure storage (vault, encrypted file) |
| **Docker Volumes**        | Weekly         | Volume backup scripts                  |

### Backup Database

```bash
# Backup PostgreSQL
docker exec myapp-db-1 pg_dump -U myuser mydatabase > backup_$(date +%Y%m%d).sql

# Restore from backup
docker exec -i myapp-db-1 psql -U myuser mydatabase < backup_20250101.sql
```

## Troubleshooting

### C√°c v·∫•n ƒë·ªÅ th∆∞·ªùng g·∫∑p

| V·∫•n ƒë·ªÅ                        | Nguy√™n nh√¢n c√≥ th·ªÉ           | Gi·∫£i ph√°p                                      |
| ----------------------------- | ---------------------------- | ---------------------------------------------- |
| **Container kh√¥ng start**     | Docker service kh√¥ng ch·∫°y    | `sudo systemctl start docker`                  |
| **Port ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng**      | Port 3000/80/443 ƒë√£ b·ªã chi·∫øm | `sudo lsof -i :3000` v√† kill process           |
| **SSL certificate fail**      | DNS ch∆∞a propagate           | ƒê·ª£i DNS update, ki·ªÉm tra `dig your-domain.com` |
| **Database connection error** | Connection string sai        | Ki·ªÉm tra DATABASE_URL trong .env               |
| **Nginx 502 Bad Gateway**     | Next.js app kh√¥ng ch·∫°y       | Ki·ªÉm tra `docker-compose logs web`             |
| **Build failed**              | Dependencies issues          | X√≥a node_modules v√† rebuild                    |
| **Permission denied**         | User kh√¥ng c√≥ quy·ªÅn          | `sudo chown -R user:user /opt/nextjs-app`      |

### Debug Commands

```bash
# Check Docker containers
docker ps -a

# Check Docker logs
docker-compose logs --tail=100 web

# Check Nginx logs
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log

# Check system resources
htop
df -h  # Disk space
free -h  # Memory

# Check network
sudo netstat -tulpn | grep :3000
sudo netstat -tulpn | grep :80
```

### Common Fixes

**Issue: Next.js app kh√¥ng respond**

```bash
# Restart containers
docker-compose restart

# Rebuild containers
docker-compose build --no-cache
docker-compose up -d
```

**Issue: Database connection refused**

```bash
# Check database container
docker-compose ps db

# Check database logs
docker-compose logs db

# Verify connection string
docker exec myapp-web-1 env | grep DATABASE_URL
```

**Issue: SSL certificate kh√¥ng renew**

```bash
# Manual renewal
sudo certbot renew

# Check certificate expiry
sudo certbot certificates
```

## Best Practices

### 1. **Environment Variables**

| Bi·∫øn            | M√¥ t·∫£                                | B·∫£o m·∫≠t                    |
| --------------- | ------------------------------------ | -------------------------- |
| `DATABASE_URL`  | PostgreSQL connection string         | ‚úÖ Kh√¥ng commit v√†o Git    |
| `NODE_ENV`      | Environment (production/development) | ‚úÖ Set trong Docker        |
| `NEXT_PUBLIC_*` | Public environment variables         | ‚ö†Ô∏è S·∫Ω exposed trong client |
| `API_KEYS`      | Third-party API keys                 | ‚úÖ Kh√¥ng expose public     |

**Security:**

- S·ª≠ d·ª•ng `.env` file v√† th√™m v√†o `.gitignore`
- Kh√¥ng commit sensitive data
- S·ª≠ d·ª•ng secrets management (AWS Secrets, Vault)

### 2. **Docker Best Practices**

| Practice               | L√Ω do                       | Implementation                   |
| ---------------------- | --------------------------- | -------------------------------- |
| **Multi-stage builds** | Gi·∫£m image size             | Separate build v√† runtime stages |
| **Non-root user**      | Security                    | Run container v·ªõi non-root user  |
| **.dockerignore**      | Faster builds               | Exclude node_modules, .git       |
| **Health checks**      | Auto-recovery               | Healthcheck trong docker-compose |
| **Resource limits**    | Prevent resource exhaustion | Set CPU/memory limits            |

### 3. **Next.js Optimization**

| Feature                                   | Benefit            | Configuration               |
| ----------------------------------------- | ------------------ | --------------------------- |
| **Image Optimization**                    | Reduce bandwidth   | Next/Image v·ªõi image loader |
| **Static Generation**                     | Faster pages       | `generateStaticParams`      |
| **ISR (Incremental Static Regeneration)** | Fresh content      | `revalidate` option         |
| **Caching**                               | Better performance | Cache headers, Redis        |
| **Middleware**                            | Request processing | `middleware.ts`             |

### 4. **Monitoring**

Setup monitoring ƒë·ªÉ theo d√µi:

| Metric               | Tool                 | Purpose                 |
| -------------------- | -------------------- | ----------------------- |
| **Server Resources** | htop, Prometheus     | CPU, RAM, Disk usage    |
| **Application Logs** | Docker logs, ELK     | Debug v√† error tracking |
| **Uptime**           | UptimeRobot, Pingdom | Monitor availability    |
| **Performance**      | New Relic, Datadog   | APM monitoring          |
| **Errors**           | Sentry               | Error tracking          |

### 5. **Backup v√† Disaster Recovery**

| Component               | Backup Method            | Frequency  |
| ----------------------- | ------------------------ | ---------- |
| **Database**            | pg_dump                  | Daily      |
| **Docker Volumes**      | Volume backup            | Weekly     |
| **Configuration Files** | Git repository           | On changes |
| **SSL Certificates**    | Let's Encrypt auto-renew | Automatic  |

### 6. **Security Checklist**

- ‚úÖ Keep system updated
- ‚úÖ Use strong passwords
- ‚úÖ Enable firewall (UFW)
- ‚úÖ SSH key authentication (disable password)
- ‚úÖ Regular security audits
- ‚úÖ Monitor logs for suspicious activity
- ‚úÖ Use HTTPS only
- ‚úÖ Security headers trong Nginx
- ‚úÖ Rate limiting
- ‚úÖ Database access restrictions

## K·∫øt lu·∫≠n

Deploy Next.js l√™n VPS l√† m·ªôt qu√° tr√¨nh ph·ª©c t·∫°p nh∆∞ng mang l·∫°i nhi·ªÅu l·ª£i √≠ch: ki·ªÉm so√°t ho√†n to√†n, chi ph√≠ linh ho·∫°t v√† h·ªçc h·ªèi v·ªÅ infrastructure. V·ªõi Docker v√† Nginx, b·∫°n c√≥ th·ªÉ setup m·ªôt production-ready deployment t∆∞∆°ng t·ª± nh∆∞ c√°c managed platforms.

### ƒêi·ªÉm m·∫•u ch·ªët

- ‚úÖ **Docker simplifies deployment** - Containerization gi√∫p d·ªÖ qu·∫£n l√Ω v√† scale
- ‚úÖ **Nginx as reverse proxy** - X·ª≠ l√Ω SSL, static files, v√† load balancing
- ‚úÖ **PostgreSQL for data** - Reliable database solution
- ‚úÖ **Automation is key** - Deploy scripts gi√∫p ti·∫øt ki·ªám th·ªùi gian
- ‚úÖ **Security matters** - SSL, firewall, v√† monitoring l√† b·∫Øt bu·ªôc

### T√†i nguy√™n tham kh·∫£o

- üì¶ [next-self-host Repository](https://github.com/leerob/next-self-host) - Source code m·∫´u
- üìπ [Self Hosting Tutorial Video](https://www.youtube.com/watch?v=sIVL4JMqRfc) - Video h∆∞·ªõng d·∫´n chi ti·∫øt
- üìö [Next.js Deployment Docs](https://nextjs.org/docs/deployment)
- üê≥ [Docker Documentation](https://docs.docker.com/)
- üåê [Nginx Documentation](https://nginx.org/en/docs/)

### B∆∞·ªõc ti·∫øp theo

1. **Setup VPS**: Mua v√† c·∫•u h√¨nh VPS server
2. **Deploy th·ª≠ nghi·ªám**: Ch·∫°y deploy script tr√™n test environment
3. **Customize**: T√πy ch·ªânh theo nhu c·∫ßu c·ªßa b·∫°n
4. **Monitor**: Setup monitoring v√† alerting
5. **Optimize**: T·ªëi ∆∞u performance v√† costs

> [!TIP]
> **B·∫Øt ƒë·∫ßu v·ªõi staging**: Tr∆∞·ªõc khi deploy production, h√£y test tr√™n staging environment ƒë·ªÉ ƒë·∫£m b·∫£o m·ªçi th·ª© ho·∫°t ƒë·ªông ƒë√∫ng!

> [!NOTE]
>
> - [Next.js Self-Host Repository](https://github.com/leerob/next-self-host)
> - [Next.js Docker Deployment Guide](https://nextjs.org/docs/deployment#docker-image)
> - [Docker Compose Documentation](https://docs.docker.com/compose/)
